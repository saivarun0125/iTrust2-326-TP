name: Build iTrust2 with Github Actions
on: 
  pull_request:
    branches:
      - '**'
  push:
    branches:
      - main
jobs:
  Build-iTrust2:
    runs-on: self-hosted
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
      - run: echo "💡 The ${{ github.repository }} repository has been cloned to the runner."
      - run: echo "🖥️ The workflow is now ready to test your code on the runner."
      - name: List files in the repository
        run: |
          ls -la ${{ github.workspace }}
     
      
      - name: Setup JDK 11
        uses: actions/setup-java@v1.4.3
        with:
          java-version: '11'

      - name: Copy config files for Spring Boot
        run: cp iTrust2/src/main/resources/application.yml.template iTrust2/src/main/resources/application.yml
        
      - name: Edit config file with DB credentials (do not change this!)
        run: sed -i 's/localhost/docker/g' iTrust2/src/main/resources/application.yml && sed -i 's/password\:/password\:\ root1234/g' iTrust2/src/main/resources/application.yml
          
      - name: Clean up Docker containers
        run: (docker stop $(docker ps -a -q) || true) && (docker rm $(docker ps -a -q) || true)
            
      - name: Set up MariaDB
        run: docker run --name mariadbtest -e MYSQL_ROOT_PASSWORD=root1234 -p 3306:3306 -d docker.io/library/mariadb:10.4
          
      - name: Wait for container to be active
        run: sleep 15s      
         
      - name: Check to make sure DB is active
        run: mysql -uroot -h docker -proot1234 -e 'SELECT version()'
      
      - name: Build iTrust2 with Maven
        run: cd iTrust2 && mvn --batch-mode --update-snapshots clean test
 
      - name: Generate coverage badges
        id: jacoco
        run: > 
            python3 .github/generate_badge.py "iTrust2/target/site/jacoco-ut/jacoco.csv"
            ".github/badges" "jacoco.svg" "branches.svg" "true" "true"
            "fail" "70" "50" "false" "false" "100 90 80 70 60 0" "#4c1 #97ca00 #a4a61d #dfb317 #fe7d37 #e05d44"
            
            
      - name: Log coverage percentage
        if: always()
        run: |
          echo "coverage = ${{ steps.jacoco.outputs.coverage }}"
          echo "branch coverage = ${{ steps.jacoco.outputs.branches }}"
          
      - name: Run CheckStyle
        if: always()
        run: |
          java -jar .github/checkstyle-8.44-all.jar -c .github/checkstyle.xml iTrust2/src/main > checkstyle.log  
          
          WARN=$(cat checkstyle.log | grep WARN | wc -l)
          if [ $WARN -gt 0 ]
          then
            echo "$(tput setaf 3)Warning!  There are $WARN checkstyle warnings.  Take a look at the log below to figure out what:$(tput sgr 0)" && cat checkstyle.log
          else
            echo "$(tput setaf 2)Checkstyle passed successfully!$(tput sgr 0)"
          fi
          rm checkstyle.log

          
      - name: Commit the code coverage badge (if it changed)
        if: always()
        run: |
          DETATCHED_HEAD_FOUND=$(git status | grep 'HEAD detached' | wc -l)
          if [[ `git status --porcelain` && $DETATCHED_HEAD_FOUND -eq 0 ]]; then
            git config --global user.name 'GLaDOS (Bot)'
            git config --global user.email 'glados@users.noreply.github.com'
            git add -A
            git commit -m "Autogenerated JaCoCo coverage badge"
            git push
          fi
