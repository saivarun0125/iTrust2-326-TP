<html xmlns:th="http://www.thymeleaf.org">

<head th:include="layout :: head(title=~{::title},links=~{::script})">
<title>Document Office Visit</title>
<script th:src="@{/js/dateTimeService.js}"
		src="../js/dateTimeService.js"></script>
</head>

<body th:include="layout :: body" th:with="content=~{::content}">
	<div th:fragment="content">
		<div class="container">

			<script th:inline="javascript">
                /* Otherwise Thymeleaf tries to parse Javascript as XML and breaks itself sometimes. */
                /*<![CDATA[*/
                var app = angular.module('myApp', ['dateTimeServices']);

                /**
                 * A filter to humanize the text to be more user friendly.
                 */
                app.filter('humanize', function() {
                    return function (input) {
                        return input.toLowerCase().split('_')
                            .map((word) => word.charAt(0).toUpperCase() + word.substring(1))
                            .join(' ');
                    }
                });

                app.controller('documentOfficeVisitCtrl', function ($scope, $http, dateTimeService) {

					$scope.errorMsg = "";

                    /*method for checking added perscriptions for vailidity*/
                    var checkValidPrescription = function (p) {
                        var err = [];
                        if (!p.drug) {
                            err.push("Prescription must be associated with a drug");
                        }
                        if (!dateTimeService.isValidDate(p.startDate)) {
                            err.push("Start date is in an invalid format");
                        }
                        if (!dateTimeService.isValidDate(p.endDate)) {
                            err.push("End date is in an invalid format");
                        }
                        if (p.startDate > p.endDate) {
                            err.push("Start date must be earlier than end date");
                        }
                        if (!/^\+?\d+$/.test(p.dosage)) {
                            err.push("Dosage must be a positive integer");
                        }
                        if (!/^\+?\d+$/.test(p.renewals)) {
                            err.push("Renewals must be an integer zero or more");
                        }

                        return err.join(". ");
                    }

                    /*Method for checking added diagnoses for validity*/
                    var checkValidDiagnosis = function (d) {
                        var err = [];
                        if (!d.code) {
                            err.push("Diagnosis must be associated with a diagnosis code");
                        }
                        return err.join(". ");
                    }

                    var checkValidProcedure = function (p) {
                        var err = [];
                        if (!p.loinc) {
                            err.push("Lab procedure must be associated with a diagnosis code");
                        }
                        if (!p.priority) {
                            err.push("Lab procedure must have an associated priority");
                        }
                        if (!p.labtech) {
                            err.push("Lab procedure must have an associated lab tech");
                        }
                        return err.join(". ");
                    }

                    $scope.three = false;
                    $scope.threeAndUp = false;
                    $scope.twelveAndUp = false;

                    /**
                     * Validates birthdate here when patient is selected.
                     */
                    $scope.patientSelect = function (patient) {
                        if (!$scope.visit) {
                            return;
                        }

                        if (!$scope.visit.actualPatient && patient) {
                            $scope.visit.actualPatient = patient;
                        } else if (!patient) {
                            if ($scope.visit.actualPatient) {
                                patient = $scope.visit.actualPatient;
                            } else {
                                // We don't have enough information to continue
                                return;
                            }
                        }

                        if (!patient.dateOfBirth) {
                            // We don't know DoB so submit everything
                            $scope.three = true;
                            $scope.threeAndUp = true;
                            $scope.twelveAndUp = true;
                            return;
                        }

                        $scope.three = false;
                        $scope.threeAndUp = false;
                        $scope.twelveAndUp = false;

                        if (!dateTimeService.isValidDate($scope.visitInputDateTime)) {
                            return; // No date yet
                        }
                        
                        const age = dateTimeService.getAge(new Date(patient.dateOfBirth), $scope.visitInputDateTime);
                        if (age < 3) {
                            $scope.three = true;
                        }
                        if (age >= 3) {
                            $scope.threeAndUp = true;
                        }
                        if (age >= 12) {
                            $scope.twelveAndUp = true;
                        }
                    }

					var currentDay, currentMonth, currentYear, currentHour, currentMinute, currentSeconds;

					function getCurrentTime() {
						var curDate = new Date();
						currentDay = curDate.getDate();
						currentMonth = curDate.getMonth() + 1;
						currentYear = curDate.getFullYear();
						currentHour = curDate.getHours();
						currentMinute = curDate.getMinutes();
						currentSeconds = curDate.getSeconds();
					}

					$scope.updateFollowupDate = function() {
						if ($scope.selectedVaccine != undefined && $scope.doseNumber != undefined && $scope.selectedVaccine.doseInterval != null) {
							var intervalAmount = parseInt($scope.selectedVaccine.doseInterval.intervalAmount);
							var intervalType = $scope.selectedVaccine.doseInterval.intervalType;

							var aptDate = new Date($scope.visitInputDateTime);

							if (intervalType == 'DAYS') {
								aptDate.setDate(aptDate.getDate() + intervalAmount);
							} else if (intervalType == 'WEEKS') {
								aptDate.setDate(aptDate.getDate() + (intervalAmount * 7));
							} else if (intervalType == "MONTHS") {
								aptDate.setMonth(aptDate.getMonth() + intervalAmount);
							} else if (intervalType == "YEARS") {
								aptDate.setFullYear(aptDate.getFullYear() + intervalAmount);
							}

							aptDate.setMilliseconds(0);
							aptDate.setSeconds(0);

							$scope.inputDateTime = aptDate;
						}
					}

					function iniOfficeVisitDateTime() {
						var curDate = new Date()
						curDate.setSeconds(0);
						curDate.setMilliseconds(0);
						$scope.visitInputDateTime = curDate;
					}

					iniOfficeVisitDateTime();

					$scope.appointment = {};

					$scope.updateFollowupVaccine = function() {
						$scope.appointment.vaccine = $scope.selectedVaccine.code;
					}

					function selectableVaccineRequest(request){

						var requestDate = new Date(request['date']);
						var formDateTime = new Date($scope.visitInputDateTime);
						upperBound = new Date(formDateTime.toISOString());
						upperBound = new Date(upperBound.setHours(upperBound.getHours() + 3));
						lowerBound = new Date(formDateTime.toISOString());
						lowerBound = new Date(lowerBound.setHours(lowerBound.getHours() - 3));

						// if the reqeust is happening on the current date, make sure it is within 3 hours
						if (requestDate >= lowerBound && requestDate <= upperBound)
							return true;
						
						return false;
					}

					// get a list of vacinators
					$http.get("/iTrust2/api/v1/users").then(
						function (response) {
							$scope.vaccinators = [];
							for (var i = 0; i < response.data.length; i++) {
								if (response.data[i]['roles'].includes("ROLE_VACCINATOR") || response.data[i]['roles'].includes("ROLE_HCP"))
									$scope.vaccinators.push(response.data[i]);
							}
						}
					);

					// get a list of the vaccines
					$http.get("/iTrust2/api/v1/CovidVaccines").then(
						function (response) {
							var vaccines = [];
							for (var i = 0; i < response.data.length; i++) {
								if (response.data[i]['available'])
									vaccines.push(response.data[i]);
							}
							$scope.vaccines = vaccines;
						}
					);

					$scope.loadVaccineAppointmentRequests = function() {
						if ($scope.visit.patient == undefined || $scope.visit.type != "VACCINE_APPOINTMENT")
							return undefined;
						
						// get a list of the appointment requests
						$http.get("/iTrust2/api/v1/vaccineappointmentrequests").then(
							function (response) {
								getCurrentTime();
								requests = [];

								for (var i = 0; i < response.data.length; i++) {

									if (selectableVaccineRequest(response.data[i]) && response.data[i].patient.username == $scope.visit.patient) {
										response.data[i]["title"] = requestTitle(response.data[i]);
										requests.push(response.data[i]);
									}
								}

								$scope.vaccineRequests = requests;
							}
						);
					}

					

					// format a readable request title
					function requestTitle(input) {

						dateStr = input['date'].split('T')[0];

						// Americanize date
						month = dateStr.split('-')[1];
						day = dateStr.split('-')[2];
						year = dateStr.split('-')[0];

						dateStr = month + "/" + day + "/" + year;


						timeStr = input['date'].split('T')[1].split('-')[0];
						hourStr = timeStr.split(':')[0];
						minStr = timeStr.split(':')[1];
						hrNum = parseInt(hourStr);

						if (hrNum < 12) {
							timeStr = (hrNum % 12) + ":" + minStr + "AM";
						} else {
							timeStr = (hrNum % 12) + ':' + minStr + "PM";
						}

						returnString = "Appointment for " + input['patient']['firstName'] + " " + input['patient']['lastName'] + " at " + timeStr + " on " + dateStr;

						return returnString;
					}

					$scope.isMixAndMatch = function() {
						return $scope.mixAndMatchWarning != "" && $scope.mixAndMatchWarning != undefined;
					}

					function validFollowupDate(date) {
						// make sure the date is within 24 hours of the interval date
						if ($scope.selectedVaccine != undefined && $scope.doseNumber != undefined) {
							var intervalAmount = parseInt($scope.selectedVaccine.doseInterval.intervalAmount);
							var intervalType = $scope.selectedVaccine.doseInterval.intervalType;

							var aptDate = new Date($scope.visitInputDateTime);

							if (intervalType == 'DAYS') {
								aptDate.setDate(aptDate.getDate() + intervalAmount);
							} else if (intervalType == 'WEEKS') {
								aptDate.setDate(aptDate.getDate() + (intervalAmount * 7));
							} else if (intervalType == "MONTHS") {
								aptDate.setMonth(aptDate.getMonth() + intervalAmount);
							} else if (intervalType == "YEARS") {
								aptDate.setFullYear(aptDate.getFullYear() + intervalAmount);
							}

							var followupDate = aptDate.getFullYear() + '-' + (aptDate.getMonth() + 1) + '-' + aptDate.getDate(); 

							aptDate.setMilliseconds(0);
							aptDate.setSeconds(0);

							lowerBound = new Date(aptDate.toISOString());
							upperBound = new Date(aptDate.toISOString());
							lowerBound = lowerBound.setDate(lowerBound.getDate() - 1);
							upperBound = upperBound.setDate(upperBound.getDate() + 1);

							// make sure the provided date is between the interval date's upper and lower bound
							if (date >= lowerBound && date <= upperBound) {
								return true;
							} else {
								return false;
							}
						}
					}

					$scope.noteFocus = function() {
						if ($scope.mixAndMatchFullyDosed) {
							if ($scope.visit.notes == undefined)
								$scope.visit.notes = "";

							var replaceStr = " This vaccine dose now certifies " + $scope.visit.patient + " as fully vaccinated as per the CDC and FDA's guidelines on interchangeably dosing with Covid19 vaccines.";

							$scope.visit.notes = $scope.visit.notes.replace(replaceStr, '');
						}
						
					}

					$scope.mixAndMatchFullChange = function() {
						if ($scope.mixAndMatchFullyDosed) {
							if ($scope.visit.notes == undefined)
								$scope.visit.notes = "";
							
							$scope.visit.notes += " This vaccine dose now certifies " + $scope.visit.patient + " as fully vaccinated as per the CDC and FDA's guidelines on interchangeably dosing with Covid19 vaccines.";
					
						} else {

							var replaceStr = " This vaccine dose now certifies " + $scope.visit.patient + " as fully vaccinated as per the CDC and FDA's guidelines on interchangeably dosing with Covid19 vaccines.";

							$scope.visit.notes = $scope.visit.notes.replace(replaceStr, '');
						}
					}

					$scope.noteBlur = function() {
						if ($scope.mixAndMatchFullyDosed) {
							if ($scope.visit.notes == undefined)
								$scope.visit.notes = "";

							$scope.visit.notes += " This vaccine dose now certifies " + $scope.visit.patient + " as fully vaccinated as per the CDC and FDA's guidelines on interchangeably dosing with Covid19 vaccines.";
						}
					}

					$scope.checkDoseNumber = function() {
						// abort if a vaccine hasn't been selected yet
						if ($scope.selectedVaccine == undefined || $scope.doseNumber == undefined)
							return undefined;

						// if the dose isn't a number, abort
						if (isNaN($scope.doseNumber)) {
							$scope.doseNumError = "Dose number must be a number."
							return undefined;
						}

						$http.get("/iTrust2/api/v1/vaccineofficevisits").then(
						function (response) {
							vaccineDoses = {};
							for (var i = 0; i < response.data.length; i++) {
								if (response.data[i].patient.username == $scope.visit.patient) {
									if (!(response.data[i].vaccine.code in vaccineDoses)) {
										vaccineDoses[response.data[i].vaccine.code] = 1;
									} else {
										vaccineDoses[response.data[i].vaccine.code] = vaccineDoses[response.data[i].vaccine.code] + 1;
									}	
								}
							}

							var doseNumber = $scope.doseNumber;

							var firstName;
							var lastName;
							var patientDOB;
							

							// get current patient
							for (var i = 0; i < $scope.patients.length; i++ ) {
								if ($scope.patients[i].username == $scope.visit.patient) {
									firstName = $scope.patients[i].firstName;
									lastName = $scope.patients[i].lastName;
									patientDOB = $scope.patients[i].dateOfBirth;
								}
							}

							// check age range
							var lowerAgeLimit = $scope.selectedVaccine.ageRange[0];
							var upperAgeLimit = $scope.selectedVaccine.ageRange[1];
							var curDate = new Date();
							patientDOB = new Date(patientDOB);
							var patientAge = (parseInt(curDate.getFullYear())) - parseInt(patientDOB.getFullYear());
							var validAge = lowerAgeLimit <= patientAge && patientAge <= upperAgeLimit;

							var currentDosage;
							if (vaccineDoses[$scope.selectedVaccine.code] == undefined) {
								currentDosage = 0;
							} else {
								currentDosage = vaccineDoses[$scope.selectedVaccine.code];
							}

							// check if they are already vaccinated with a coivd vaccine
							var dosedWith = [];
							dosedWith.push($scope.selectedVaccine.name);
							var alreadyDosed = false;
							$scope.mixAndMatchWarning = "";
							var keepLooping = true;
							var fullyVaccinatedMessage = "";
							for (var i = 0; i < $scope.vaccines.length && keepLooping; i++) {
								if ($scope.vaccines[i].code in vaccineDoses && $scope.selectedVaccine.code != $scope.vaccines[i].code) {
									if ($scope.vaccines[i].numDoses == vaccineDoses[$scope.vaccines[i].code])
										fullyVaccinatedMessage += firstName + " " + lastName + " is already fully vaccinated with the " + $scope.vaccines[i].name + " vaccine.\n";
 									alreadyDosed = true;
									var plural = "doses";
									if (vaccineDoses[$scope.vaccines[i].code] == 1)
										plural = "dose";

									$scope.mixAndMatchWarning += "WARNING: " + firstName + " " + lastName + " already has " + vaccineDoses[$scope.vaccines[i].code] + " " + plural + " " + " of the " + $scope.vaccines[i].name + " vaccine.\n"
									dosedWith.push($scope.vaccines[i].name);
								}
							}

							if (alreadyDosed) {
								$scope.mixAndMatchWarning += "Please review current FDA and CDC guidelines for interchangeably dosing between the";
								for (var i = 1; i < dosedWith.length - 1; i++) {
									$scope.mixAndMatchWarning += " " + dosedWith[i] + ",";
								}
								$scope.mixAndMatchWarning += " and " + dosedWith[dosedWith.length - 1];
								$scope.mixAndMatchWarning += " vaccines.";
							}
								

							$scope.showDoseWarningBtn = false;
							$scope.errorMsg = $scope.errorMsg.replace("Confirm the dosage number with the patient before submitting\n", '');

							// if the dose number isn't 1 + the patient's current dosage, return error 
							if (fullyVaccinatedMessage != "") {
								$scope.doseNumError = fullyVaccinatedMessage;
								$scope.mixAndMatchWarning = "";
								$scope.errorMsg = $scope.errorMsg.replace("Patient already fully vaccinated against Covid19\n", '');
								$scope.errorMsg += "Patient already fully vaccinated against Covid19\n";
							} else if (!($scope.selectedVaccine.code in vaccineDoses) && doseNumber == 1) {
								// if the patient hasn't recieved the vaccine before the dose number should be 1
								$scope.doseNumError = "";
								$scope.errorMsg = $scope.errorMsg.replace("Invalid dose number\n", '');
								$scope.errorMsg = $scope.errorMsg.replace("Patient already fully vaccinated against Covid19\n", '');
							} else if (doseNumber > $scope.selectedVaccine.numDoses) {
								var plural = "doses";
								if (currentDosage == 1)
									plural = "dose";

								$scope.doseNumError = "The " + $scope.selectedVaccine.name + " vaccine only requires " + $scope.selectedVaccine.numDoses + " " + plural + ".";
								$scope.errorMsg = $scope.errorMsg.replace("Invalid dose number\n", '');
								$scope.errorMsg = $scope.errorMsg.replace("Patient already fully vaccinated against Covid19\n", '');
								$scope.errorMsg += "Invalid dose number\n";
							} else if (doseNumber == 1 + currentDosage){
								// if the patient has recieved the vaccine before the dose number should be 1+ current dose
								$scope.doseNumError = "";
								$scope.errorMsg = $scope.errorMsg.replace("Invalid dose number\n", '');
								$scope.errorMsg = $scope.errorMsg.replace("Patient already fully vaccinated against Covid19\n", '');
							} else if ($scope.doseNumber <= currentDosage) {
								var plural = "doses";
								if (currentDosage == 1)
									plural = "dose";


								$scope.doseNumError = "The dose number of this visit can't be equal to or less than their current dose (" + currentDosage + " " + plural + ").";
								$scope.errorMsg = $scope.errorMsg.replace("Invalid dose number\n", '');
								$scope.errorMsg += "Invalid dose number\n";
							}  else {
								// if the above criteria aren't met, something is wrong, print error
								$scope.doseNumError = "WARNING: " + firstName + " " + lastName + " has " + currentDosage + " recorded doses of the " + $scope.selectedVaccine.name + " vaccine. Their next dose should be dose number " + (currentDosage + 1) + ", please confirm that they have recieved doses elsewhere before continuing.";
								$scope.unRecordedVisits = doseNumber - currentDosage - 1;
								$scope.currentDosage = currentDosage;
								$scope.errorMsg = $scope.errorMsg.replace("Invalid dose number\n", '');
								$scope.errorMsg = $scope.errorMsg.replace("Confirm the dosage number with the patient before submitting\n", '');
								$scope.errorMsg = $scope.errorMsg.replace("Patient already fully vaccinated against Covid19\n", '');
								$scope.errorMsg += "Confirm the dosage number with the patient before submitting\n";
								$scope.showDoseWarningBtn = true;
							}
							if (!validAge)
								$scope.doseNumError = "Patient isn't withing the age range for the " + $scope.selectedVaccine.name + " vaccine.";
						});
					}

					var doseWarningConfirmSubmit = false;

					function submitMissingDosageVisits(visit) {	
						visit['hcp'] = /*[[${#httpServletRequest.remoteUser}]]*/null; /* Ugly hack; use this to retrieve the name of the HCP who is currently logged in.  This grabs it from Thymeleaf */
                        visit.status = "PENDING";

						// Error checking
						if (!visit.type) {
							$scope.errorMsg += "Please select a visit type\n";
						}

						if (!visit.hospital) {
							$scope.errorMsg += "Please select a hospital\n";
						}

						// Validate date and time
						var date = new Date($scope.InputDateTime);
						if (!dateTimeService.isValidDate($scope.visitInputDateTime)) {
							$scope.errorMsg += "Please input a valid date and time for the office visit\n";
						}

						if (visit.type == 'VACCINE_APPOINTMENT') {
						
							// vaccine office visit error checking
							// vaccine appointment undefined and the appointment was prescheduled
							if ($scope.selectedVaccineAppointment == undefined && visit.prescheduled) {
								$scope.errorMsg += "Please select a vaccine appointment request.\n"
							}
						
							// vaccine type undefined
							if ($scope.selectedVaccine == undefined) {
								$scope.errorMsg += "Please select a vaccine type.\n"
							}
						
							// dose number is undefined
							if ($scope.doseNumber == undefined) {
								$scope.errorMsg += "Please enter the dose number the patient is recieving.\n"
							} else if (isNaN($scope.doseNumber)) {
								// dose number isn't a number
								$scope.errorMsg += "The dose number must be a number.\n"
							}

							if ($scope.errorMsg == "" || $scope.errorMsg == undefined) {
								if ($scope.prescheduled()) {
									visit['appointment'] = $scope.selectedVaccineAppointment['id'];
								} else {
									visit['appointment'] = null;
								}
									
								visit['vaccine'] = $scope.selectedVaccine['code'];
								visit['date'] = $scope.visitInputDateTime;
								$http({
                            		method: 'POST',
                            		url: '/iTrust2/api/v1/vaccineofficevisits',
                            		data: visit
                            	}).then(function (response) {
                            		$scope.errorMsg = "";
									$scope.visit.type = "VACCINE_APPOINTMENT";
                            		$scope.message = "Office visit created successfully";
                            	}, function (rejection) {
									$scope.message = "";
                            	})
							}
						}
					}

					function sleep(ms) {
  						return new Promise(resolve => setTimeout(resolve, ms));
					}

					$scope.confirmDosageWarning = async function() {

						$scope.errorMsg = $scope.errorMsg.replace("Confirm the dosage number with the patient before submitting\n", '');
						$scope.doseNumError = "";
						$scope.showDoseWarningBtn = false;

						var visit = $scope.visit;
						for (var i = 1; i <= $scope.unRecordedVisits; i++) {
							$scope.visit['doseNumber'] = $scope.currentDosage + i + "";
							doseWarningConfirmSubmit = true;
							var submitVisit = {};
							Object.assign(submitVisit, $scope.visit);
							submitMissingDosageVisits(submitVisit);
							$scope.visit = visit;
							await sleep(2000);
						}
					}

					$scope.updatePreferred = function(){
						if ($scope.selectedVaccineAppointment.vaccine['available']) {
							$scope.preferredVaccine = $scope.selectedVaccineAppointment.vaccine.name + " is preferred."
						} else {
							$scope.preferredVaccine = $scope.selectedVaccineAppointment.vaccine.name + " is preferred, but not available."
						}
							
					}

					$scope.checkFollowupDate = function() {
						var validDate = validFollowupDate($scope.inputDateTime);
						if (!validDate) {
							var intervalType = $scope.selectedVaccine.doseInterval.intervalType.toLowerCase();
							var intervalAmount = $scope.selectedVaccine.doseInterval.intervalAmount;

							if (intervalAmount == 1)
								intervalType = intervalType.substring(0, intervalType.length - 1);

							$scope.followUpDateError = "Follow up appointment date must be within 24 hours of " + intervalAmount + " " + intervalType + " past the office visit date and time for the " + $scope.selectedVaccine.name + " vaccine.";
							$scope.errorMsg = $scope.errorMsg.replace("Invalid follow up date\n", "");
							$scope.errorMsg += "Invalid follow up date\n";
						} else {
							$scope.followUpDateError = "";
							$scope.errorMsg = $scope.errorMsg.replace("Invalid follow up date\n", "");
						}
					}

					$scope.submitWithFollowup = function() {
						$scope.withFollowup = true;
						$scope.errorMsg = "";

						if ($scope.appointment.hcp == undefined) {
							$scope.errorMsg += "Please select a hcp for the follow up appointment.\n";
						}

						if (!validFollowupDate($scope.inputDateTime)) {
							$scope.errorMsg += "Please select a valid date and time for the follow up appointment.\n"
						}

						if ($scope.visit.patient == undefined) {
							$scope.errorMsg += "Please select a patient.\n";
						}
						$scope.submit();
					}

                    /*Getting a list of patients*/
                    $http.get("/iTrust2/api/v1/patients").then(
                        function (response) {
                            $scope.patients = response.data;
                        });					
                    /*Getting a list of appointment types*/
                    $http.get("/iTrust2/api/v1/appointmenttype")
                        .then(function (response) {
                            $scope.types = response.data;
                        });
                    /*Getting a list of house smoking options*/
                    $http.get("/iTrust2/api/v1/housesmoking")
                        .then(function (response) {
                            $scope.housesmoking = response.data;
                        });
                    /*Getting a list of patient smoking options*/
                    $http.get("/iTrust2/api/v1/patientsmoking")
                        .then(function (response) {
                            $scope.patientsmoking = response.data;
                        });
                    /*Getting a list of hospitals*/
                    $http.get("/iTrust2/api/v1/hospitals").then(
                        function (response) {
                            $scope.hospitals = response.data;
                        });
                    /*Getting a list of drugs*/
                    $http.get("/iTrust2/api/v1/drugs").then(
                        function (response) {
							$scope.drugs = [];
							// load only generic drugs into drugs
							for (var i = 0; i < response.data.length; i++) {
								if (!("doseInterval" in response.data[i]))
									$scope.drugs.push(response.data[i])
							}
                        });
                    /*Getting a list of ICD codes*/
                    $http.get("/iTrust2/api/v1/icdcodes").then(
                        function (response) {
                            $scope.icdcodes = response.data;
                        });

                    /*Getting a list of laboratory procedures*/
                    $http.get("/iTrust2/api/v1/personnel/getbyroles/ROLE_LABTECH").then(
                        function (response) {
                            $scope.tech = response.data;
                            var techLength = $scope.tech.length;
                            for (i = 0; i < techLength; i++) {
                                //passing to inner loop taken from https://stackoverflow.com/questions/17244614/passing-variable-to-promise-in-a-loop
                                (function (i) {
                                    $http.get("/iTrust2/api/v1/labprocedures/byUser/" + $scope.tech[i].self.username).then(
                                        function (response) {
                                            $scope.tech[i].numAssigned = response.data.length;
                                        }, function (rejection) {
                                            $scope.tech[i].numAssigned = "UNKNOWN";
                                        });
                                })(i);
                            }
                        });

                    /*Getting a list of lionc codes*/
                    /*
                    $http.get("/iTrust2/api/v1/loinccodes").then(
                        function (response) {
                            $scope.loinccodes = response.data;
                        });
*/

                    /*Checks Basic Health Metrics for correctness*/
                    function checkBasicHealthMetrics() {
                    	
                    	// Basic health metrics are not required for GENERAL_OPHTHALMOLOGY office visits
                    	
                    	// Check if height is valid or optional for this type of visit
                    	var invalidHeight = /^[0-9]{1,3}(\.[0-9]?)?$/.test(String($scope.visit.height).replace(/^0+/, '')) == false;
                        if (invalidHeight) {
                            $scope.errorMsg += "Height/length can be up to a 3-digit positive number and potentially one digit of decimal precision\n"
                        }
                    	
                    	// Check if weight is valid or optional for this type of visit
                    	var invalidWeight = /^[0-9]{1,3}(\.[0-9]?)?$/.test(String($scope.visit.weight).replace(/^0+/, '')) == false;
                        if (invalidWeight) {
                            $scope.errorMsg += "Weight can be up to a 3-digit positive number and potentially one digit of decimal precision\n"
                        }
                    	
                    	// Check if head circumference is valid for this type of visit
                    	var invalidHeadCircumference = $scope.three && /^[0-9]{1,3}(\.[0-9]?)?$/.test(String($scope.visit.headCircumference).replace(/^0+/, '')) == false;
                    	if (invalidHeadCircumference) {
                            $scope.errorMsg += "Head circumference can be up to a 3-digit positive number and potentially one digit of decimal precision\n"
                        }
                    	
                    	// Check if systolic is valid for this type of visit
                    	var invalidSystolic = $scope.threeAndUp && /^[0-9]{1,3}$/.test(String($scope.visit.systolic).replace(/^0+/, '')) == false;
                    	if (invalidSystolic) {
                            $scope.errorMsg += "Systolic blood pressure can be up to a 3-digit positive number\n"
                        }
                    	
                    	// Check if diastolic is valid for this type of visit
                    	var invalidDiastolic = $scope.threeAndUp && /^[0-9]{1,3}$/.test(String($scope.visit.diastolic).replace(/^0+/, '')) == false;
                        if (invalidDiastolic) {
                            $scope.errorMsg += "Diastolic blood pressure can be up to a 3-digit positive number\n"
                        }
                        
                        // Check if HDL is valid for this type of visit
                       	if ($scope.twelveAndUp && /^[0-9]{1,2}$/.test(String($scope.visit.hdl).replace(/^0+/, '')) == false) {
                            $scope.errorMsg += "HDL cholesterol can be a number between 0 and 90\n"
                        } else if ($scope.twelveAndUp) {
                            var hdlInt = parseInt($scope.visit.hdl);
                            if (hdlInt > 90) {
                                $scope.errorMsg += "HDL cholesterol can be a number between 0 and 90\n"
                            }
                        }
                        
                        // Check if LDL is valid for this type of visit
                        if ($scope.twelveAndUp && /^[0-9]{1,3}$/.test(String($scope.visit.ldl).replace(/^0+/, '')) == false) {
                            $scope.errorMsg += "LDL cholesterol can be a number between 0 and 600\n"
                        } else if ($scope.twelveAndUp) {
                            var ldlInt = parseInt($scope.visit.ldl);
                            if (ldlInt > 600) {
                                $scope.errorMsg += "LDL cholesterol can be a number between 0 and 600\n"
                            }
                        }
                        
                        // Check if triglycerides are valid for this type of visit
                        if ($scope.twelveAndUp && /^[0-9]{1,3}$/.test(String($scope.visit.tri).replace(/^0+/, '')) == false) {
                            $scope.errorMsg += "Triglycerides can be a number between 100 and 600\n"
                        } else if ($scope.twelveAndUp) {
                            var triInt = parseInt($scope.visit.tri);
                            if (triInt > 600 || triInt < 100) {
                                $scope.errorMsg += "Triglycerides can be a number between 100 and 600\n"
                            }
                        }
                        
                        if ($scope.visit.houseSmokingStatus == undefined) {
                            $scope.errorMsg += "Please select one of the listed household smoking statuses\n";
                        }
                        if ($scope.twelveAndUp && $scope.visit.patientSmokingStatus == undefined) {
                            $scope.errorMsg += "Please select one of the listed patient smoking statuses\n";
                        }
                    }

                    /*Checks validity of eye health metrics*/
                    function checkEyeHealthMetrics() {
                    	
                    	var inputVal = $scope.visit.ophthalmologyVisitForm.visualAcuityLeft;
                        if (/^[0-9]{1,3}?$/.test(String(inputVal).replace(/^0+/, '')) == false) {
                            $scope.errorMsg += "Visual Acuity (L) must be an integer value between 10 and 200 inclusive\n"
                        } else if (parseInt(inputVal) < 10 || parseInt(inputVal) > 200) {
                            $scope.errorMsg += "Visual Acuity (L) must be an integer value between 10 and 200 inclusive\n"
                        }

                        inputVal = $scope.visit.ophthalmologyVisitForm.visualAcuityRight;
                        if (/^[0-9]{1,3}?$/.test(String(inputVal).replace(/^0+/, '')) == false) {
                            $scope.errorMsg += "Visual Acuity (R) must be an integer value between 10 and 200 inclusive\n"
                        } else if (parseInt(inputVal) < 10 || parseInt(inputVal) > 200) {
                            $scope.errorMsg += "Visual Acuity (R) must be an integer value between 10 and 200 inclusive\n"
                        }

                        inputVal = $scope.visit.ophthalmologyVisitForm.sphereLeft;
                        if (/^[\-\+]?(?=.*\d)\d\d?(?:\.\d\d?)?$/.test(String(inputVal)) == false) {
                            $scope.errorMsg += "Sphere (L) must be a floating point number up to two digits followed by 2 decimal places\n"
                        }
                        
                        inputVal = $scope.visit.ophthalmologyVisitForm.sphereRight;
                        if (/^[\-\+]?(?=.*\d)\d\d?(?:\.\d\d?)?$/.test(String(inputVal)) == false) {
                            $scope.errorMsg += "Sphere (R) must be a floating point number up to two digits followed by 2 decimal places\n"
                        }

                        var inputCylinderLeft = $scope.visit.ophthalmologyVisitForm.cylinderLeft;
                        var inputCylinderRight = $scope.visit.ophthalmologyVisitForm.cylinderRight;
                        var inputAxisLeft = $scope.visit.ophthalmologyVisitForm.axisLeft;
                        var inputAxisRight = $scope.visit.ophthalmologyVisitForm.axisRight;
                        
                        if (inputCylinderLeft != undefined || inputCylinderRight != undefined ||
                        		inputAxisLeft != undefined || inputAxisRight != undefined) {
                            if (/^[\-\+]?(?=.*\d)\d\d?(?:\.\d\d?)?$/.test(String(inputCylinderLeft)) == false) {
                                $scope.errorMsg += "Cylinder (L) must be a floating point number up to two digits followed by 2 decimal places\n"
                            }
                            if (/^[\-\+]?(?=.*\d)\d\d?(?:\.\d\d?)?$/.test(String(inputCylinderRight)) == false) {
                                $scope.errorMsg += "Cylinder (R) must be a floating point number up to two digits followed by 2 decimal places\n"
                            }
                            
                            if (/^[0-9]{1,3}?$/.test(String(inputAxisLeft).replace(/^0+/, '')) == false) {
                                $scope.errorMsg += "Axis (L) must be an integer value between 1 and 180 inclusive\n"
                            } else if (parseInt(inputAxisLeft) < 1 || parseInt(inputAxisLeft) > 180) {
                                $scope.errorMsg += "Axis (L) must be an integer value between 1 and 180 inclusive\n"
                            }
                            if (/^[0-9]{1,3}?$/.test(String(inputAxisRight).replace(/^0+/, '')) == false) {
                                $scope.errorMsg += "Axis (R) must be an integer value between 1 and 180 inclusive\n"
                            } else if (parseInt(inputAxisRight) < 1 || parseInt(inputAxisRight) > 180) {
                                $scope.errorMsg += "Axis (R) must be an integer value between 1 and 180 inclusive\n"
                            }
                        }

                        
                        if ($scope.visit.type == "OPHTHALMOLOGY_SURGERY" && !$scope.visit.surgeryType) {
                            $scope.errorMsg += "Please select one of the listed surgery types\n";
                        }
                    }

                    /**
                     * Checks if any BHM have been entered for OPH visit.
                     */
                    function validateBasicHealthMetrics() {
                        const checkValues = [
                            $scope.visit.height,
                            $scope.visit.weight,
                            $scope.visit.headCircumference,
                            $scope.visit.systolic,
                            $scope.visit.diastolic,
                            $scope.visit.hdl,
                            $scope.visit.ldl,
                            $scope.visit.tri,
                            $scope.visit.patientSmokingStatus,
                            $scope.visit.houseSmokingStatus
                        ];

                        return checkValues.some((value) => { return value; });
                    }

					$scope.visit = {};

					$scope.getButtonTemplate = function() {
						if ($scope.visit.type == "VACCINE_APPOINTMENT" && "doseNumber" in $scope && "selectedVaccine" in $scope && $scope.doseNumber < $scope.selectedVaccine.numDoses) {
							return "officevisitandvaccinerequest";
						} else {
							return "officevisitonly";
						}
					}

                    /*Submit function*/
                    $scope.submit = function () {

						// if there is a followup appointment, save the error messages
						if ($scope.withFollowup == false){
							$scope.errorMsg = "";
                        	$scope.message = "";
						}
                        
                        $scope.visit.hcp = /*[[${#httpServletRequest.remoteUser}]]*/null; /* Ugly hack; use this to retrieve the name of the HCP who is currently logged in.  This grabs it from Thymeleaf */
                        $scope.visit.status = "PENDING";

                        // Error checking
                        if (!$scope.visit.type) {
                            $scope.errorMsg += "Please select a visit type\n";
                        }

                        if (!$scope.visit.hospital) {
                            $scope.errorMsg += "Please select a hospital\n";
                        }

                        // Validate date and time
                        var date = new Date($scope.visitInputDateTime);
                        if (!dateTimeService.isValidDate($scope.visitInputDateTime)) {
                            $scope.errorMsg += "Please input a valid date and time for the office visit\n";
                        }
                        
                        /*Submitting Office Visits by type*/
                        if ($scope.visit.type === 'GENERAL_CHECKUP' || $scope.visit.type === 'GENERAL_OPHTHALMOLOGY') {
                        	
                        	// Check if values are valid
                        	if ($scope.visit.type == 'GENERAL_CHECKUP') {
                        		
                        		checkBasicHealthMetrics();
                        		
                        	} else if ($scope.visit.type == 'GENERAL_OPHTHALMOLOGY') {
                        		
                            	if (validateBasicHealthMetrics()) {
                            		// At least one of the BHM fields were filled out
                            		// So they all must be checked.
                            		checkBasicHealthMetrics();
                            	}
                            	
                            	checkEyeHealthMetrics();
                            	
                            }
                            
                            if ($scope.errorMsg == "") {
                                $scope.visit.diagnoses = $scope.diagnoses;
                                $scope.visit.prescriptions = $scope.prescriptions;
                                $scope.visit.prescriptions.forEach(function (p) {
                                    p.patient = $scope.visit.patient;
                                });

                                $scope.visit.labProcedures = $scope.procedures;

								

								$http({
                                	method: 'POST',
                                	url: '/iTrust2/api/v1/officevisits',
                                	data: $scope.visit
                                }).then(function (response) {
                                	$scope.errorMsg = "";
                                	$scope.message = "Office visit created successfully";
                                }, function (rejection) {
                                	$scope.message = "";
                                	$scope.errorMsg = "Error occurred creating office visit: " + rejection.data.message;
                                })

                                
                                
                            }
                        } else if ($scope.visit.type == 'VACCINE_APPOINTMENT') {

							// vaccine office visit error checking
							// vaccine appointment undefined and the appointment was prescheduled
							if ($scope.selectedVaccineAppointment == undefined && $scope.visit.prescheduled) {
								$scope.errorMsg += "Please select a vaccine appointment request.\n"
							}

							// vaccine type undefined
							if ($scope.selectedVaccine == undefined) {
								$scope.errorMsg += "Please select a vaccine type.\n"
							}

							// dose number is undefined
							if ($scope.doseNumber == undefined) {
								$scope.errorMsg += "Please enter the dose number the patient is recieving.\n"
							} else if (isNaN($scope.doseNumber)) {
								// dose number isn't a number
								$scope.errorMsg += "The dose number must be a number.\n"
							}

							if ($scope.errorMsg == "" || $scope.errorMsg == undefined) {
								var visit = $scope.visit;
								if ($scope.prescheduled()) {
									visit['appointment'] = $scope.selectedVaccineAppointment['id'];
								} else {
									visit['appointment'] = null;
								}
									
								if (!doseWarningConfirmSubmit)
									visit['doseNumber'] = $scope.doseNumber;
								visit['vaccine'] = $scope.selectedVaccine['code'];
								visit['date'] = $scope.visitInputDateTime;
								$http({
                            		method: 'POST',
                            		url: '/iTrust2/api/v1/vaccineofficevisits',
                            		data: visit
                            	}).then(function (response) {
									// create a vaccine appointmetn request if it's a followup
									if ($scope.withFollowup == true) {
										createVaccineAppointmentRequest();
									}  else {
										$scope.errorMsg = "";
										$scope.visit = {};
										$scope.visit.type = "VACCINE_APPOINTMENT";
										$scope.visitInputDateTime = undefined;
										$scope.selectedVaccineAppointment = {};
										$scope.doseNumber = undefined;
										$scope.selectedVaccine = {};
										$scope.preferredVaccine = "";
                            			$scope.message = "Office visit created successfully";
									}
									// reset for next submit
									$scope.withFollowup = false;
									doseWarningConfirmSubmit = false;
                            	}, function (rejection) {
									$scope.message = "";								
                            	})

							} else {
								$scope.message = "";
							}

							
						} else {
                            $scope.message = "";
                            $scope.errorMsg = "Invalid office visit type";
                        }

                    } //end submit function

					function createVaccineAppointmentRequest() {
						if ($scope.errorMsg == "") {
							// get an updated list of the appointments that are in the system
							var requests;
							$http.get("/iTrust2/api/v1/vaccineappointmentrequests").then(
							function (response) {
								requests = response.data;

								for (var i = 0; i < requests.length; i++) {
									var sameUser = requests[i].patient.username == $scope.visit.patient;
									var sameVaccine = requests[i].vaccine.code == $scope.selectedVaccine.code;
									var databaseDate = new Date(requests[i].date);
									var formDate = new Date($scope.visit.inputDateTime);
									var isAfter = databaseDate > formDate

									var alreadyExisted = false;

									// if it's the same user and the same vaccine. And the existing appointment in the database is in the future
									if (sameUser && sameVaccine && isAfter) {
										$scope.appointment["status"] = "APPROVED";
										$scope.appointment['date'] = $scope.inputDateTime.toISOString(); 
										$scope.appointment['type'] = "VACCINE_APPOINTMENT";
										$scope.appointment['patient'] = $scope.visit.patient;
										$http.put("/iTrust2/api/v1/vaccineappointmentrequests/" + requests[i].id, $scope.appointment).then( 
										function(response) {
												$scope.message = "";
												$scope.message += "Follow up appointment existed for patient, updated to new time and date.\n";
                            					$scope.message += "Office visit created successfully.";
												$scope.recentlyModifiedRequest = response.data['id'];
												$scope.appointment = {};
												$scope.appointment.vaccine = $scope.selectedVaccine;
												$scope.inputDateTime = undefined;
												$scope.errorMsg = "";
												$scope.visit = {};
												$scope.visit.type = "VACCINE_APPOINTMENT";
												$scope.visitInputDateTime = undefined;
												$scope.selectedVaccineAppointment = {};
												$scope.doseNumber = undefined;
												$scope.selectedVaccine = {};
												$scope.preferredVaccine = "";
											}, function(rejection) {
												$scope.message = "";
                            					$scope.message += "Office visit created successfully.";
												$scope.errorMsg += "Could not complete appointment request"
											});
										alreadyExisted = true;
									}

								}

								// if no other appointment existed, add new appointment
								if (!alreadyExisted) {
									$scope.appointment["status"] = "APPROVED";
									$scope.appointment['date'] = $scope.inputDateTime.toISOString(); 
									$scope.appointment['type'] = "VACCINE_APPOINTMENT";
									$scope.appointment['patient'] = $scope.visit.patient;
									$http.post("/iTrust2/api/v1/vaccineappointmentrequestsHCP", $scope.appointment).then( 
									function(response) {
										$scope.message = "";
										$scope.message += "Follow up appointment request has been requested successfully.\n"
										$scope.message += "Office visit created successfully.\n";
										$scope.recentlyModifiedRequest = response.data['id'];
										$scope.appointment = {};
										$scope.appointment.vaccine = $scope.selectedVaccine;
										$scope.inputDateTime = undefined;
										$scope.errorMsg = "";
										$scope.visit = {};
										$scope.visit.type = "VACCINE_APPOINTMENT";
										$scope.visitInputDateTime = undefined;
										$scope.selectedVaccineAppointment = {};
										$scope.doseNumber = undefined;
										$scope.selectedVaccine = {};
										$scope.preferredVaccine = "";
									}, function(rejection) {
										$scope.message = "";
										$scope.message += "Office visit created successfully.";
										$scope.errorMsg += "Could not complete appointment request"
									});
								}
							});
						}
					}

                    $scope.noteEntry = "";
                    $scope.codeEntry = "";

                    $scope.drugEntry = "";
                    $scope.dosageEntry = "";
                    $scope.startEntry = "";
                    $scope.endEntry = "";
                    $scope.renewalEntry = "";

                    $scope.loincEntry = "";
                    $scope.priorityEntry = "";
                    $scope.techEntry = "";

                    $scope.procedure = {};
                    $scope.procedures = [];

                    // Clears local variables for diagnosis form
                    function resetDiagnosisForm() {
                        $scope.noteEntry = "";
                        $scope.codeEntry = "";
                    }

                    // Clears local variables for prescription form
                    function resetPrescriptionForm() {
                        $scope.drugEntry = "";
                        $scope.dosageEntry = "";
                        $scope.startEntry = "";
                        $scope.endEntry = "";
                        $scope.renewalEntry = "";
                    }

                    // Capture each diagnosis into an array
                    $scope.diagnoses = [];
                    $scope.eyediagnoses = [];
                    $scope.fillDiagnosis = function () {
                        $scope.errorMsg = "";
                        var d = {
                            note: $scope.noteEntry,
                            code: $scope.codeEntry.code
                        }
                        var err = checkValidDiagnosis(d);
                        if (err) {
                            $scope.errorMsg = err;
                            $scope.message = "";
                        } else {
                            $scope.diagnoses.push(d);
                            resetDiagnosisForm();
                        }
                    }

                    $scope.fillEyeDiagnosis = function () {
                        $scope.errorMsg = "";
                        if(!$scope.eyediagnoses.includes($scope.codeEntry))
                        	$scope.eyediagnoses.push($scope.codeEntry);
                        resetDiagnosisForm();
                    }

                    //capture each prescription into an array
                    $scope.prescriptions = [];
                    $scope.fillPrescription = function () {
                        $scope.errorMsg = "";
                        var p = {
                            drug: $scope.drugEntry,
                            dosage: $scope.dosageEntry,
                            startDate: $scope.startEntry,
                            endDate: $scope.endEntry,
                            renewals: $scope.renewalEntry
                        }
                        
                        var err = checkValidPrescription(p);
                        if (err) {
                            $scope.errorMsg = err;
                            $scope.message = "";
                        } else {
                            p.startDate = dateTimeService.toDateString(p.startDate);
                            p.endDate = dateTimeService.toDateString(p.endDate);
                            $scope.prescriptions.push(p);
                            resetPrescriptionForm();
                        }
                    }

					$scope.prescheduled = function() {
						return $scope.visit.prescheduled;
					}

					$scope.noErrors = function() {
						return ($scope.doseNumError == "" || $scope.doseNumError == undefined) && ($scope.followUpDateError == "" || $scope.followUpDateError == undefined);
					}

					$scope.clearRequestErrors = function() {

						if ($scope.selectedVaccine != undefined && $scope.doseNumber != undefined) {
							if ($scope.doseNumber >= $scope.selectedVaccine.numDoses)
								$scope.followUpDateError = "";
						}
						
					}

                    /*Adding a procedure to Office visit*/
                    $scope.addProcedure = function () {
                        var procCopy = {};
                        $scope.errorMsg = "";
                        $scope.procedure.patient = $scope.visit.actualPatient.self;
                        $scope.procedure.status = "ASSIGNED";
                        angular.copy($scope.procedure, procCopy);
                        var err = checkValidProcedure($scope.procedure);
                        if (err) {
                            $scope.errorMsg = err;
                            $scope.message = "";
                        } else {
                            $scope.procedures.push(procCopy);
                            $scope.procedure = {};
                            $scope.message = "Lab procedure added successfully";
                        }
                    }

                    //remove local diagnosis from list
                    $scope.removeDiagnosis = function ($index) {
                        $scope.diagnoses.splice($index, 1);
                    }

                    //remove local prescription from list
                    $scope.removePrescription = function ($index) {
                        $scope.prescriptions.splice($index, 1);
                    }

                    //remove local procedure from list
                    $scope.removeProcedure = function ($index) {
                        $scope.procedures.splice($index, 1);
                    }

					function deleteRequest(id) {
						$http.delete('iTrust2/api/v1/appointmentrequests/' + id).then(function (response) {
                            				$scope.errorMsg += "Error creating office visit, vaccine appointment request not saved.";
                            			}, function(rejection) {
											$scope.errorMsg += "Error creating office visit, vaccine appointment was still saved."
										});
					}

                    //call initally
                    resetDiagnosisForm();
                    resetPrescriptionForm();
                });
			/*]]>*/
            </script>

			<div ng-app="myApp" ng-controller="documentOfficeVisitCtrl">
				<div class="row">
					<div class="col-md-12">
						<div class="panel panel-primary">
							<div class="panel-heading">
								<h3>Office Visit</h3>
							</div>
							<div class="panel-body">
								<div class="row">
									<div class="form-group col-md-2 text-left">
										<label for="time">Date and Time of Office Visit:</label> <input id="timevisit" type="datetime-local"
											name="timevisit" class="form-control" ng-model="visitInputDateTime"
											required="true" step="60" style="width:225px" ng-change="loadVaccineAppointmentRequests()"/>
									</div>

									<div class="form-group col-md-2 text-right">
										<div class="checkbox">
											<label> <input type="checkbox" name="preScheduled"
												class="checkbox" ng-model="visit.prescheduled" ng-change="loadVaccineAppointmentRequests()">Prescheduled?
											</label>
										</div>
									</div>
								</div>
								<div class="row">
									<div class="form-group col-md-4">
										<label>Patient:</label>

										<div class="panel panel-default">
											<div class="panel-body">
												<div class="form-check">
													<ul
														style="max-height: 15%; overflow: auto; list-style: none;">
														<li ng-repeat="patient in patients | filter:searchFilter">
															<label> <input type="radio"
																ng-model="$parent.visit.patient" name="name"
																value="{{patient.username}}" required="true"
																ng-change='patientSelect(patient); loadVaccineAppointmentRequests(); checkDoseNumber()'
																id="{{patient.username}}" />&nbsp;{{patient.username}}
														</label>
														</li>
													</ul>
												</div>
											</div>
										</div>
									</div>
									<div class="form-group col-md-4">
										<label>Type of Visit:</label>

										<div class="panel panel-default">
											<div class="panel-body">
												<div class="form-check">
													<ul
														style="max-height: 15%; overflow: auto; list-style: none;">
														<li ng-repeat="type in types"><label> <input
																type="radio" ng-model="$parent.visit.type" ng-change="loadVaccineAppointmentRequests()"
																name="{{type}}" value="{{type}}" required="true" /> {{type
																| humanize}}
														</label></li>
													</ul>
												</div>
											</div>
										</div>
									</div>
									<div class="form-group col-md-4">
										<label>Hospital:</label>
										<div class="panel panel-default">
											<div class="panel-body">
												<div class="form-check">
													<ul
														style="max-height: 15%; overflow: auto; list-style: none;">
														<li ng-repeat="hospital in hospitals"><label>
																<input type="radio" ng-model="$parent.visit.hospital"
																name="hospital" value="{{hospital.name}}"
																required="true" /> {{hospital.name}}
														</label></li>
													</ul>
												</div>
											</div>
										</div>
									</div>
								</div>
								<div class="row">

									<!-- Basic Health Metrics Panel -->
									<div class="col-md-4" ng-hide="visit.type == 'VACCINE_APPOINTMENT'">
										<div class="panel panel-info">
											<div class="panel-heading">
												<h4>Basic Health Metrics <span ng-show="visit.type == 'GENERAL_OPHTHALMOLOGY'">(Optional)</span></h4>
											</div>
											<div class="panel-body">
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Height/Length:</label>
													</div>
													<div class="col-xs-6">
														<input class="form-control" name="height"
															ng-model="visit.height" required="true" type="text">
													</div>
												</div>
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Weight:</label>
													</div>
													<div class="col-xs-6">
														<input class="form-control" name="weight"
															ng-model="visit.weight" required="true" type="text">
													</div>
												</div>
												<div class="form-group row" ng-show="three">
													<div class="col-xs-6">
														<label>Head Circumference:</label>
													</div>
													<div class="col-xs-6">
														<input class="form-control" name="head"
															ng-model="visit.headCircumference" required="true"
															type="text">
													</div>
												</div>
												<div class="form-group row" ng-show="threeAndUp">
													<div class="col-xs-6">
														<label>Systolic:</label>
													</div>
													<div class="col-xs-6">
														<input class="form-control" name="systolic"
															ng-model="visit.systolic" required="true" type="text">
													</div>
												</div>
												<div class="form-group row" ng-show="threeAndUp">
													<div class="col-xs-6">
														<label>Diastolic:</label>
													</div>
													<div class="col-xs-6">
														<input class="form-control" name="diastolic"
															ng-model="visit.diastolic" required="true" type="text">
													</div>
												</div>
												<div class="form-group row" ng-show="twelveAndUp">
													<div class="col-xs-6">
														<label>HDL:</label>
													</div>
													<div class="col-xs-6">
														<input class="form-control" name="hdl"
															ng-model="visit.hdl" required="true" type="text">
													</div>
												</div>
												<div class="form-group row" ng-show="twelveAndUp">
													<div class="col-xs-6">
														<label>LDL:</label>
													</div>
													<div class="col-xs-6">
														<input class="form-control" name="ldl"
															ng-model="visit.ldl" required="true" type="text">
													</div>
												</div>
												<div class="form-group row" ng-show="twelveAndUp">
													<div class="col-xs-6">
														<label>Triglycerides:</label>
													</div>
													<div class="col-xs-6">
														<input class="form-control" name="tri"
															ng-model="visit.tri" required="true" type="text">
													</div>
												</div>
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Household Smoking Status:</label>
													</div>
													<div class="col-xs-6 radio-box">
														<div class="form-check">
															<ul style="list-style: none;">
																<li ng-repeat="hsmokes in housesmoking"><label>
																		<input type="radio"
																		ng-model="$parent.visit.houseSmokingStatus"
																		name="houseSmokingStatus" value="{{hsmokes}}"
																		required="true" /> {{hsmokes | humanize}}
																</label></li>
															</ul>
														</div>
													</div>
												</div>
												<div class="form-group row" ng-show="twelveAndUp">
													<div class="col-xs-6">
														<label>Patient Smoking Status:</label>
													</div>
													<div class="col-xs-6 radio-box">
														<div class="form-check">
															<ul style="list-style: none;">
																<li ng-repeat="psmokes in patientsmoking"><label>
																		<input type="radio"
																		ng-model="$parent.visit.patientSmokingStatus"
																		name="patientSmokingStatus" value="{{psmokes}}"
																		required="true" /> {{psmokes | humanize}}
																</label></li>
															</ul>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
									
									<!-- Vaccine Appointment Visit only -->
									<div class="col-md-4" ng-show="visit.type == 'VACCINE_APPOINTMENT'">
										<div class="panel panel-info">
											<div class="panel-heading">
												<h4>Vaccine Information</h4>
											</div>
											<div class="panel-body">
												<div class="form-group row">
													<div class="col-md-12" style="padding-bottom:8px;">
														<label>Vaccine Appointment: </label>
														<select required="true" ng-disabled="!prescheduled()" ng-options="request.title for request in vaccineRequests" ng-change="updatePreferred()" ng-model="selectedVaccineAppointment" class="form-control"></select>
													</div>
													<div class="col-md-3">
														<label>Dose Number: </label>
														<input type=text ng-model="doseNumber" class="form-control" ng-change="updateFollowupDate(); checkDoseNumber(); clearRequestErrors()"/>
														
													</div>
													<div class="form-group row">
														<div class="col-xs-6">
															<label>Vaccine Type: </label>
															<select style="width:350px;" ng-options="vaccine.name for vaccine in vaccines" ng-model="selectedVaccine" class="form-control" ng-change="updateFollowupVaccine(); updateFollowupDate(); checkDoseNumber()">
																<option value="" disabled selected>{{preferredVaccine}}</option>
															</select>
														</div>
													</div>
													<label class="text" style="white-space: pre-line;">{{mixAndMatchWarning}}</label>
													<div ng-show="isMixAndMatch()" ng-hide="!isMixAndMatch()">
														<label class="text" style="display: inline-block;">Is the patient fully vaccinated after this dose?: </label><input type=checkbox ng-model="mixAndMatchFullyDosed" ng-change="mixAndMatchFullChange()" style="display: inline-block; margin-left:10px;" class="checkbox"/>
													</div>
													<label class="text-danger">{{doseNumError}}</label>
													<input class="btn-danger" type=button ng-show="showDoseWarningBtn" ng-hide="!showDoseWarningBtn" ng-click="confirmDosageWarning()" value="Confirm"/>
												</div>
												
												
											</div>
										</div>
									</div>

									<div class="col-md-4" ng-show="doseNumber < selectedVaccine.numDoses">
										<div class="panel panel-info">
											<div class="panel-heading">
												<h4>Schedule Followup Vaccination Appointment</h4>
											</div>
											<div class="panel-body">
												<div class="form-group row">
													<div class="col-xs-6">
														<label for="type">Preferred Vaccine:</label> 
														<select class="form-control" ng-options="vaccine.code as vaccine.name for vaccine in vaccines" ng-disabled="true" ng-model="appointment.vaccine"></select>
													</div>
													<div class="col-xs-6">
														<label for="hcp">HCP:</label>
														<select ng-model="appointment.hcp" name="hcp" id="hcp"
														class="form-control">
														<option ng-repeat="vaccinator in vaccinators" value="{{vaccinator.username}}">{{vaccinator.username}} ({{vaccinator.statistics.averageVisitSatisfaction == 0 ? 'N/A' : ((vaccinator.statistics.averageVisitSatisfaction + vaccinator.statistics.averageTreatmentSatisfaction) / 2 ) + '/5 stars'}})</option>
														</select>
													</div>
												</div>
				
												<div class="form-group">
													
												</div>
				
												<div class="form-group">
													<label for="time">Date and Time:</label> <input id="time" type="datetime-local"
														name="time" class="form-control" ng-model="inputDateTime"
														required="true" step="60" ng-change="checkFollowupDate()"/>
												</div>

												<label class="text-danger">{{followUpDateError}}</label>
				
												<div class="form-group">
													<label for="comments">Comments:</label>
													<textarea id="comments" class="form-control"
														ng-model="appointment.comments" name="comments">
													</textarea>
												</div>
												
											</div>
										</div>
									</div>
									
									<!-- Ophthalmology-only: Eye Metrics panel -->
									<div ng-show="visit.type == 'GENERAL_OPHTHALMOLOGY'" class="col-md-4">
										<div class="panel panel-info">
											<div class="panel-heading">
												<h4>Eye Metrics</h4>
											</div>
											<div class="panel-body">
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Acuity (L):</label>
													</div>
													<div class="col-xs-6">
														<input class="form-control" name="visualAcuityLeft"
															ng-model="visit.ophthalmologyVisitForm.visualAcuityLeft" required="true" type="text">
													</div>
												</div>
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Acuity (R):</label>
													</div>
													<div class="col-xs-6">
														<input class="form-control" name="visualAcuityRight"
															ng-model="visit.ophthalmologyVisitForm.visualAcuityRight" required="true" type="text">
													</div>
												</div>
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Sphere (L):</label>
													</div>
													<div class="col-xs-6">
														<input class="form-control" name="sphereLeft"
															ng-model="visit.ophthalmologyVisitForm.sphereLeft" required="true"
															type="text">
													</div>
												</div>
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Sphere (R):</label>
													</div>
													<div class="col-xs-6">
														<input class="form-control" name="sphereRight"
															ng-model="visit.ophthalmologyVisitForm.sphereRight" required="true" type="text">
													</div>
												</div>
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Cylinder (L):</label>
													</div>
													<div class="col-xs-6">
														<input class="form-control" name="cylinderLeft"
															ng-model="visit.ophthalmologyVisitForm.cylinderLeft" required="true" type="text">
													</div>
												</div>
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Cylinder (R):</label>
													</div>
													<div class="col-xs-6">
														<input class="form-control" name="cylinderRight"
															ng-model="visit.ophthalmologyVisitForm.cylinderRight" required="true" type="text">
													</div>
												</div>
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Axis (L):</label>
													</div>
													<div class="col-xs-6">
														<input class="form-control" name="axisLeft"
															ng-model="visit.ophthalmologyVisitForm.axisLeft" required="true" type="text">
													</div>
												</div>
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Axis (R):</label>
													</div>
													<div class="col-xs-6">
														<input class="form-control" name="axisRight"
															ng-model="visit.ophthalmologyVisitForm.axisRight" required="true" type="text">
													</div>
												</div>
												
											</div>
										</div>
									</div>

									<!-- Diagnosis Panel  -->
									<div ng-show="visit.type == 'GENERAL_CHECKUP' || visit.type == 'GENERAL_OPHTHALMOLOGY'" class="col-md-4">
										<div class="panel panel-info">
											<div class="panel-heading">
												<h4>Diagnosis</h4>
											</div>
											<div class="panel-body">
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Diagnosis:</label>
													</div>
													<div class="col-xs-6 radio-box">
														<div class="form-check">
															<ul style="list-style: none;">
																<li ng-repeat="i in icdcodes"><label> <input
																		type="radio" ng-model="$parent.codeEntry"
																		id="{{i.code}}" name="{{i.description}}" ng-value="i"
																		required="true" /> {{i.code}} - {{i.description}}
																</label></li>
															</ul>
														</div>
													</div>
												</div>
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Notes:</label>
													</div>
													<div class="col-xs-6">
														<input class="form-control" name="notesEntry"
															ng-model="noteEntry" required="true" type="text">
													</div>
												</div>

												<div class="form-group row text-center">
													<div class="col-md-12">
														<button class="btn btn-success" ng-click="fillDiagnosis()"
															name="fillDiagnosis">Add Diagnosis</button>
													</div>
												</div>

												<div class="form-group row">
													<div class="col-md-12">
														<div class="panel panel-default">
															<div class="panel-heading">Added Diagnoses</div>
															<div class="panel-body">
																<div class="row" ng-repeat="d in diagnoses">
																	<div class="col-md-4">{{d.code}}</div>
																	<div class="col-md-4">
																		<button class="btn btn-danger btn-xs"
																			ng-click="removeDiagnosis($index)"
																			name="removeDiagnosis">
																			<b>x</b>
																		</button>
																	</div>
																</div>
															</div>
														</div>
													</div>
												</div>

											</div>
										</div>
									</div>


									<!-- Prescription Panel -->
									<div ng-show="visit.type == 'GENERAL_CHECKUP'" class="col-md-4">
										<div class="panel panel-info">
											<div class="panel-heading">
												<h4>Prescription</h4>
											</div>
											<div class="panel-body">
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Drug:</label>
													</div>
													<div class="col-xs-6 radio-box">
														<div class="form-check">
															<ul style="list-style: none;">
																<li ng-repeat="d in drugs"><label> <input
																		type="radio" ng-model="$parent.drugEntry"
																		name="{{d.name}}" value="{{d.code}}" required="true" />
																		{{d.name}}
																</label></li>
															</ul>
														</div>
													</div>
												</div>
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Dosage:</label>
													</div>
													<div class="col-xs-4">
														<input class="form-control" name="dosageEntry"
															ng-model="dosageEntry" required></input>
													</div>
													<div class="col-xs-2">
														<span id="helpBlock" class="help-block">mg</span>
													</div>
												</div>
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Start Date:</label>
													</div>
													<div class="col-xs-6">
														<input type="date" class="form-control" name="startEntry"
															ng-model="startEntry" required />
													</div>
												</div>
												<div class="form-group row">
													<div class="col-xs-6">
														<label>End Date:</label>
													</div>
													<div class="col-xs-6">
														<input type="date" class="form-control" name="endEntry"
															ng-model="endEntry" required />
													</div>
												</div>
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Renewals:</label>
													</div>
													<div class="col-xs-4">
														<input class="form-control" name="renewalEntry"
															ng-model="renewalEntry" required></input>
													</div>
												</div>
												<div class="form-group row text-center">
													<button class="btn btn-success"
														ng-click="fillPrescription()" name="fillPrescription">Add
														Prescription</button>
												</div>
												<div class="form-group row">
													<div class="col-md-12">
														<div class="panel panel-default">
															<div class="panel-heading">Added Prescriptions</div>
															<div class="panel-body">
																<div class="row" ng-repeat="p in prescriptions">
																	<div class="col-md-3">{{p.drug}}</div>
																	<div class="col-md-2">{{p.dosage}}mg</div>
																	<br>
																	<div class="col-md-1"></div>
																	<!-- "tab" over columns -->
																	<div class="col-md-3">{{p.startDate | date :
																		'MM/dd/yyyy'}}</div>
																	<div class="col-md-3">{{p.endDate | date :
																		'MM/dd/yyyy'}}</div>
																	<div class="col-md-3">{{p.renewals}}</div>
																	<div class="col-md-1">
																		<button class="btn btn-danger btn-xs"
																			ng-click="removePrescription($index)"
																			name="removePrescription">
																			<b>x</b>
																		</button>
																	</div>
																</div>
															</div>
														</div>
													</div>
												</div>
											</div>
										</div>
									</div>
								</div>

								<!-- Lab Procedures Panel -->
								<div ng-show="visit.type == 'GENERAL_CHECKUP'" class="row">
									<div class="col-md-4">
										<div class="panel panel-info">
											<div class="panel-heading">
												<h4>Lab Procedures</h4>
											</div>
											<div class="panel-body">
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Procedure Code:</label>
													</div>
													<div class="col-xs-6">
														<ul>
															<li ng-repeat="l in loinccodes"><label> <input
																	type="radio" ng-model="procedure.loinc"
																	name="{{l.commonName}}" ng-value="l" value="{{l.code}}"
																	required="true" /> {{l.commonName}}
															</label></li>
														</ul>
													</div>
												</div>
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Priority:</label>
													</div>
													<div class="col-xs-6">
														<select name="priority" ng-model="procedure.priority"
															required="true">
															<option value="CRITICAL">Critical</option>
															<option value="HIGH">High</option>
															<option value="MEDIUM">Medium</option>
															<option value="LOW">Low</option>
														</select>
													</div>
												</div>
												<!-- List of Lab Techs -->
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Lab Techs:</label>
													</div>
													<div class="col-xs-6 radio-box">
														<div class="form-check">
															<ul style="list-style: none;">
																<li ng-repeat="t in tech"><label> <input
																		type="radio" ng-model="procedure.labtech"
																		name="{{t.self.username}}" ng-value="t.self"
																		value="{{t.self.username}}" required="true"
																		id="radio-{{t.self.username}}" /> {{t.self.username}}
																		({{t.numAssigned}} assigned)
																</label></li>
															</ul>
														</div>
													</div>
												</div>
												<!-- Comments for lab procedure -->
												<div class="form-group row">
													<div class="col-xs-6">
														<label>Notes:</label>
														<textarea name="procNotes" ng-model="procedure.comments"
															class="form-control" rows="3"></textarea>

													</div>
												</div>
												<!-- Add procedure button -->
												<div class="form-group row text-center">
													<button class="btn btn-success" ng-click="addProcedure()"
														name="addProcedure">Add Procedure</button>
												</div>

												<!-- Currently added procedures -->
												<div class="form-group row">
													<div class="col-md-12">
														<div class="panel panel-default">
															<div class="panel-heading">Added Procedures</div>
															<div class="panel-body">
																<div class="row" ng-repeat="p in procedures">
																	<div>
																		<b>Code:</b> {{p.loinc.code}} <br> 
																		<b>Common Name:</b> {{p.loinc.commonName}} <br>
																		<b>Priority:</b> {{p.priority}} <br>
																		<b>Status:</b> {{p.status}} <br>
																		<b>Comments:</b> {{p.comments}} <br>
																	</div>
																	<br>
																</div>
															</div>
														</div>
													</div>
												</div>

											</div>
										</div>
									</div>

								</div>
								<!-- Notes and Error Messages -->
								<div class="row">
									<div class="form-group col-md-6">
										<label>Notes:</label>
										<textarea name="notes" ng-model="visit.notes"
											class="form-control" rows="3" ng-focus="noteFocus()" ng-blur="noteBlur()"></textarea>
									</div>
									<div class="col-md-12 text-right">
										<div style="white-space: pre-line;">
											<div name="success" class="text-success">{{message}}</div>
											<div name="errorMsg" class="text-danger">{{errorMsg}}</div>
										</div>
									</div>
								</div>
							</div>

							<script type="text/ng-template" id="officevisitonly">
								<button class="btn btn-primary btn-lg" ng-click="submit()"
									name="submit" ng-disabled="!noErrors()">Submit Office Visit</button>
							</script>

							<script type="text/ng-template" id="officevisitandvaccinerequest">
								<button class="btn btn-primary btn-lg" ng-click="submitWithFollowup()"
									name="submit" ng-disabled="!noErrors()">Submit Office Visit and Vaccine Appointment Request</button>
							</script>

							<!-- was form -->
							<div class="panel-footer text-right" ng-include="getButtonTemplate()">
								<!-- button may have to be inside form tag, or just a submit function for the form? -->
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</body>

</html>